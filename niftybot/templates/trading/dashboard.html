{% extends 'base.html' %}

{% block title %}Dashboard - Trade with Naman{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg: #0a0e17;
        --card-bg: rgba(20, 25, 35, 0.78);
        --card-border: rgba(88, 166, 255, 0.16);
        --glass-border: rgba(100, 180, 255, 0.20);
        --text: #e9effa;
        --text-muted: #a0a8b8;
        --primary: #60a5fa;
        --primary-dark: #3b82f6;
        --success: #34d399;
        --danger: #f87171;
        --warning: #fbbf24;
        --glow-success: 0 0 20px rgba(52, 211, 153, 0.55);
        --glow-danger: 0 0 18px rgba(248, 113, 113, 0.45);
        --glow-primary: 0 0 22px rgba(96, 165, 250, 0.55);
    }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .trading-bg {
        position: fixed;
        inset: 0;
        z-index: -2;
        pointer-events: none;
        background: radial-gradient(circle at 30% 70%, rgba(30, 58, 138, 0.14), transparent 65%);
    }

    .trading-bg::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(10, 14, 23, 0.94) 0%, rgba(10, 14, 23, 0.78) 100%);
        backdrop-filter: blur(3px);
    }

    .market-flow {
        position: absolute;
        inset: 0;
        opacity: 0.3;
    }

    .flow-line {
        position: absolute;
        height: 1.2px;
        width: 180%;
        background: linear-gradient(90deg, transparent, var(--primary) 35%, transparent 65%);
        filter: blur(1.2px);
        opacity: 0.55;
        animation: flow 100s linear infinite;
    }

    .flow-line:nth-child(odd) {
        background: linear-gradient(90deg, transparent, var(--success) 35%, transparent 65%);
    }

    @keyframes flow {
        0% { transform: translateX(-45%); }
        100% { transform: translateX(45%); }
    }

    .card, .stat-card {
        background: var(--card-bg);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid var(--glass-border);
        border-radius: 18px;
        box-shadow: 0 12px 35px rgba(0,0,0,0.38);
        transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        overflow: hidden;
        position: relative;
    }

    .card:hover, .stat-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        border-color: rgba(96, 165, 250, 0.38);
    }

    .stat-card {
        padding: 2rem 1.6rem;
        text-align: center;
    }

    .stat-card .icon {
        font-size: 2.1rem;
        margin-bottom: 0.9rem;
        opacity: 0.9;
    }

    .stat-card .value {
        font-size: 2.6rem;
        font-weight: 800;
        letter-spacing: -1.2px;
        line-height: 1;
        margin-bottom: 0.5rem;
        transition: all 0.4s ease;
        min-height: 3.2rem; /* prevent layout shift when "Calculating..." */
    }

    .stat-card .label {
        font-size: 0.95rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 500;
    }

    .status-running {
        color: var(--success);
        font-weight: 800;
        text-shadow: var(--glow-success);
    }

    .profit { color: var(--success) !important; text-shadow: var(--glow-success); }
    .loss   { color: var(--danger)   !important; text-shadow: var(--glow-danger); }

    h1, h5 {
        font-weight: 700;
        letter-spacing: -0.6px;
    }

    h1 {
        font-size: 2.6rem;
        background: linear-gradient(90deg, #e9effa, #60a5fa, #a5d6ff, #60a5fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: shine 6s linear infinite;
    }

    @keyframes shine {
        to { background-position: 200% center; }
    }

    .btn-primary {
        background: var(--primary);
        border: none;
        font-weight: 600;
        border-radius: 12px;
        padding: 0.85rem 1.8rem;
        box-shadow: 0 6px 18px rgba(96,165,250,0.4);
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: #3b82f6;
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(59,130,246,0.55);
    }

    .btn-outline-primary {
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
    }

    .table-responsive {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(96, 165, 250, 0.25);
    }

    .table {
        --bs-table-color: #ffffff !important;
        --bs-table-bg: rgba(25, 35, 55, 0.82) !important;
        --bs-table-accent-bg: rgba(35, 48, 70, 0.90) !important;
        --bs-table-hover-bg: rgba(59, 130, 246, 0.30) !important;
        --bs-table-border-color: rgba(148, 163, 184, 0.50) !important;
        margin-bottom: 0;
    }

    .table thead th {
        background: rgba(10, 15, 30, 0.98) !important;
        color: #ffffff !important;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        border-bottom: 3px solid rgba(96, 165, 250, 0.6) !important;
        padding: 1.1rem 0.8rem;
    }

    .table tbody td {
        padding: 0.95rem 0.8rem;
        vertical-align: middle;
        border-top: 1px solid rgba(148, 163, 184, 0.30);
        color: #ffffff !important;
    }

    .table tbody tr:hover {
        background: rgba(59, 130, 246, 0.35) !important;
    }

    .table .profit {
        color: #4ade80 !important;
        font-weight: 800;
        text-shadow: 0 0 8px rgba(74, 222, 128, 0.6);
    }

    .table .loss {
        color: #fb7185 !important;
        font-weight: 800;
        text-shadow: 0 0 8px rgba(251, 113, 133, 0.6);
    }

    .badge.bg-success {
        background-color: #10b981 !important;
        color: white !important;
        font-weight: 700;
        box-shadow: 0 2px 10px rgba(16, 185, 129, 0.5);
    }

    .badge.bg-danger {
        background-color: #ef4444 !important;
        color: white !important;
        font-weight: 700;
        box-shadow: 0 2px 10px rgba(239, 68, 68, 0.5);
    }

    .badge.bg-warning {
        background-color: #f59e0b !important;
        color: black !important;
        font-weight: 700;
    }

    .badge.bg-secondary {
        background-color: #64748b !important;
        color: white !important;
        font-weight: 700;
    }

    .fade-in-up {
        opacity: 0;
        transform: translateY(25px);
        animation: fadeUp 0.9s ease-out forwards;
    }

    @keyframes fadeUp {
        to { opacity: 1; transform: translateY(0); }
    }

    .stat-card:nth-child(1) { animation-delay: 0.15s; }
    .stat-card:nth-child(2) { animation-delay: 0.3s;  }
    .stat-card:nth-child(3) { animation-delay: 0.45s; }
    .stat-card:nth-child(4) { animation-delay: 0.6s;  }

    @media (max-width: 767px) {
        h1 { font-size: 2.1rem; }
        .stat-card .value { font-size: 2.1rem; }
        .stat-card { padding: 1.6rem 1.3rem; }
        .stat-card .icon { font-size: 1.8rem; }
        .table thead th { font-size: 0.82rem; padding: 0.9rem 0.6rem; }
        .table tbody td { font-size: 0.9rem; padding: 0.75rem 0.6rem; }
    }

    .number-change {
        animation: pulse 1.2s ease-out;
    }

    @keyframes pulse {
        0%   { transform: scale(1.08); }
        50%  { transform: scale(0.95); }
        100% { transform: scale(1); }
    }

    .calculating {
        color: var(--warning);
        font-style: italic;
        opacity: 0.8;
    }

    #last-updated {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-align: right;
        margin-top: 0.5rem;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}

<!-- Background -->
<div class="trading-bg">
    <div class="market-flow">
        <div class="flow-line" style="top: 12%; animation-duration: 85s;"></div>
        <div class="flow-line" style="top: 32%; animation-duration: 100s;"></div>
        <div class="flow-line" style="top: 52%; animation-duration: 115s;"></div>
        <div class="flow-line" style="top: 72%; animation-duration: 95s;"></div>
    </div>
</div>

<main class="flex-grow-1">
    <div class="container-fluid py-4 dashboard-content">
        <div class="row mb-5">
            <div class="col-12">
                <h1 class="fade-in-up">
                    <i class="fas fa-tachometer-alt me-3"></i>
                    Trading Dashboard
                </h1>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-power-off icon status-running"></i>
                    <div class="value status-running" id="bot-status-value">
                        {% if bot_status.is_running %}
                            Running
                        {% else %}
                            Stopped
                        {% endif %}
                    </div>
                    <div class="label">Algo Status</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-rupee-sign icon" style="color: var(--success);"></i>
                    <div class="value {% if daily_pnl and daily_pnl.pnl >= 0 %}profit{% elif daily_pnl %}loss{% else %}text-muted{% endif %}" id="today-pnl">
                        {% if daily_pnl %}
                            {% if daily_pnl.pnl >= 0 %}+{% endif %}₹{{ daily_pnl.pnl|floatformat:2 }}
                        {% else %}
                            ₹0.00
                        {% endif %}
                    </div>
                    <div class="label">Today's P&L</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-calendar-week icon" style="color: var(--primary);"></i>
                    <div class="value {% if weekly_pnl >= 0 %}profit{% else %}loss{% endif %}" id="weekly-pnl">
                        {% if weekly_pnl >= 0 %}+{% endif %}₹{{ weekly_pnl|floatformat:2 }}
                    </div>
                    <div class="label">Weekly P&L</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-calendar-month icon" style="color: var(--primary);"></i>
                    <div class="value {% if monthly_pnl >= 0 %}profit{% else %}loss{% endif %}" id="monthly-pnl">
                        {% if monthly_pnl >= 0 %}+{% endif %}₹{{ monthly_pnl|floatformat:2 }}
                    </div>
                    <div class="label">Monthly P&L</div>
                </div>
            </div>
        </div>

        <!-- Control & Summary -->
        <div class="row mt-5 g-4">
            <div class="col-lg-8">
                <div class="card fade-in-up">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Algo Control</h5>
                        <span class="badge {% if bot_status.is_running %}bg-success{% else %}bg-danger{% endif %} px-4 py-2 fs-6">
                            {% if bot_status.is_running %}Live{% else %}Offline{% endif %}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-4">
                                        <strong>Status:</strong> 
                                        <span id="bot-status-detail" class="{% if bot_status.is_running %}status-running{% else %}text-danger{% endif %} fw-bold ms-2">
                                            {% if bot_status.is_running %}RUNNING{% else %}STOPPED{% endif %}
                                        </span>
                                    </li>
                                    <li class="mb-4">
                                        <strong>Heartbeat:</strong> 
                                        <span id="heartbeat-status" class="ms-2">
                                            Calculating...
                                        </span>
                                    </li>
                                    <li class="mb-4">
                                        <strong>Current P&L:</strong> 
                                        <span id="current-pnl" class="{% if bot_status.current_unrealized_pnl >= 0 %}profit{% else %}loss{% endif %} fw-bold ms-2">
                                            {% if bot_status.current_unrealized_pnl >= 0 %}+{% endif %}₹{{ bot_status.current_unrealized_pnl|floatformat:2|default:"0.00" }}
                                        </span>
                                    </li>
                                    <li class="mb-4">
                                        <strong>Current Margin:</strong> 
                                        <span class="ms-2">
                                            ₹{{ bot_status.current_margin|floatformat:2|default:"0.00" }}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid gap-3 mt-3 mt-md-0">
                                    <a href="{% url 'strategies_list' %}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-brain me-2"></i> Manage & Run Algo
                                    </a>
                                </div>
                            </div>
                        </div>

                        {% if bot_status.last_error %}
                            <div class="alert alert-danger mt-4 mb-0" role="alert">
                                <strong>Last Error:</strong>
                                <pre class="mb-0 mt-2 bg-transparent border-0 text-danger" style="font-size: 0.92rem; white-space: pre-wrap;">{{ bot_status.last_error }}</pre>
                            </div>
                        {% endif %}

                        <div id="last-updated" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Performance Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-4">
                            <span>Win Rate</span>
                            <strong class="fs-5">{{ win_rate|default:"0" }}%</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Weekly Trades</span>
                            <strong class="fs-5">{{ weekly_trades|default:"0" }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Monthly Trades</span>
                            <strong class="fs-5">{{ monthly_trades|default:"0" }}</strong>
                        </div>

                        <div class="d-flex justify-content-between mb-4">
                            <span>Best Day</span>
                            <div class="text-end">
                                <div id="best-day-pnl" class="fw-bold text-success">
                                    {% if performance.best_day %}
                                        {% if performance.best_day.pnl >= 0 %}+{% endif %}₹{{ performance.best_day.pnl|floatformat:2 }}
                                    {% else %}
                                        ₹0.00
                                    {% endif %}
                                </div>
                                <small id="best-day-date">{{ performance.best_day.date|default:"No data" }}</small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mb-4">
                            <span>BAD Day</span>
                            <div class="text-end">
                                <div id="bad-day-pnl" class="fw-bold text-danger">
                                    {% if performance.worst_day %}
                                        {% if performance.worst_day.pnl >= 0 %}
                                            +₹{{ performance.worst_day.pnl|floatformat:2 }}
                                        {% else %}
                                            ₹{{ performance.worst_day.pnl|floatformat:2 }}
                                        {% endif %}
                                    {% else %}
                                        ₹0.00
                                    {% endif %}
                                </div>
                                <small id="bad-day-date">{{ performance.worst_day.date|default:"No data" }}</small>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="text-center">
                            <a href="{% url 'pnl_calendar' %}" class="btn btn-outline-primary">
                                <i class="fas fa-calendar-alt me-2"></i> View Calendar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card fade-in-up">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i> Recent Trades</h5>
                        <a href="#" class="btn btn-sm btn-outline-primary">View All Trades</a>
                    </div>
                    <div class="card-body p-0">
                        {% if recent_trades %}
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Symbol</th>
                                            <th>Direction</th>
                                            <th>Qty</th>
                                            <th>Entry</th>
                                            <th>Exit</th>
                                            <th>P&L</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for trade in recent_trades %}
                                            <tr>
                                                <td>{{ trade.entry_time|date:"H:i:s" }}</td>
                                                <td class="fw-medium">{{ trade.symbol }}</td>
                                                <td>
                                                    {% if "BUY" in trade.metadata.action|upper %}
                                                        <span class="badge bg-success">BUY</span>
                                                    {% elif "SELL" in trade.metadata.action|upper %}
                                                        <span class="badge bg-danger">SELL</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ trade.metadata.action }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ trade.quantity }}</td>
                                                <td>₹{{ trade.entry_price|floatformat:2 }}</td>
                                                <td>
                                                    {% if trade.exit_price %}
                                                        ₹{{ trade.exit_price|floatformat:2 }}
                                                    {% else %}
                                                        —
                                                    {% endif %}
                                                </td>
                                                <td class="{% if trade.pnl >= 0 %}profit{% else %}loss{% endif %} fw-bold">
                                                    {% if trade.pnl >= 0 %}+{% endif %}₹{{ trade.pnl|floatformat:2 }}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if trade.status == 'EXECUTED' %}success{% elif trade.status == 'PENDING' %}warning{% else %}danger{% endif %}">
                                                        {{ trade.status }}
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                                <p>No recent trades executed yet.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Navigation -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card fade-in-up">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-compass me-2"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3 col-6">
                                <a href="{% url 'broker' %}" class="btn btn-outline-primary w-100 py-3">
                                    <i class="fas fa-plug me-2"></i> Broker Setup
                                </a>
                            </div>
                            <div class="col-md-3 col-6">
                                <a href="{% url 'pnl_calendar' %}" class="btn btn-outline-success w-100 py-3">
                                    <i class="fas fa-calendar-alt me-2"></i> P&L Calendar
                                </a>
                            </div>
                            <div class="col-md-3 col-6">
                                <a href="{% url 'strategies_list' %}" class="btn btn-outline-info w-100 py-3">
                                    <i class="fas fa-brain me-2"></i> Strategies
                                </a>
                            </div>
                            <div class="col-md-3 col-6">
                                <a href="/admin/" class="btn btn-outline-secondary w-100 py-3" target="_blank">
                                    <i class="fas fa-cog me-2"></i> Admin Panel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<script>
// ────────────────────────────────────────────────
// REAL LIVE DASHBOARD - Always polling, reliable & fast
// ────────────────────────────────────────────────

let isRefreshing = false;
let lastUpdateTime = new Date();

function refreshDashboard(silent = false) {
    if (isRefreshing) return;
    isRefreshing = true;

    const statusValueEl = document.getElementById('bot-status-value');
    const statusDetailEl = document.getElementById('bot-status-detail');
    const heartbeatEl = document.getElementById('heartbeat-status');
    const lastUpdatedEl = document.getElementById('last-updated');

    if (!silent && heartbeatEl) heartbeatEl.textContent = "Updating...";

    fetch('{% url "dashboard_stats" %}', {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        // 1. Bot Status - update FIRST
        if (statusValueEl) {
            const isRunning = !!data.bot_running;
            statusValueEl.textContent = isRunning ? 'Running' : 'Stopped';
            statusValueEl.className = isRunning ? 'value status-running' : 'value text-danger';
        }

        if (statusDetailEl) {
            statusDetailEl.innerHTML = data.bot_running 
                ? '<span class="status-running">RUNNING</span>' 
                : '<span class="text-danger">STOPPED</span>';
        }

        // 2. Heartbeat
        if (heartbeatEl) {
            heartbeatEl.textContent = data.last_heartbeat_ago || 'Never';
            heartbeatEl.className = data.last_heartbeat_ago?.includes('min') ? 'text-success' : 'text-warning';
        }

        // 3. Current P&L - fast & visible update
        const pnlEl = document.getElementById('current-pnl');
        if (pnlEl) {
            const newPnl = Number(data.current_unrealized_pnl || 0).toFixed(2);
            const oldPnl = pnlEl.textContent.replace(/[^0-9.-]/g, '').trim();

            if (newPnl !== oldPnl) {
                const sign = data.current_unrealized_pnl >= 0 ? '+' : '';
                pnlEl.textContent = `${sign}₹${Number(newPnl).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                pnlEl.classList.add('number-change');
                setTimeout(() => pnlEl.classList.remove('number-change'), 1200);

                pnlEl.className = `fw-bold ms-2 ${data.current_unrealized_pnl >= 0 ? 'profit' : 'loss'}`;
            }
        }

        // 4. Today / Weekly / Monthly
        ['today', 'weekly', 'monthly'].forEach(key => {
            const el = document.getElementById(`${key}-pnl`);
            if (el && data[`${key}_pnl`] !== undefined) {
                const val = Number(data[`${key}_pnl`]).toFixed(2);
                const oldVal = el.textContent.replace(/[^0-9.-]/g, '').trim();
                const sign = data[`${key}_pnl`] >= 0 ? '+' : '';
                el.textContent = `${sign}₹${Number(val).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;

                if (oldVal !== val) {
                    el.classList.add('number-change');
                    setTimeout(() => el.classList.remove('number-change'), 1200);
                }

                el.className = `value ${data[`${key}_pnl`] >= 0 ? 'profit' : 'loss'}`;
            }
        });

        // 5. Best Day & BAD Day
        const bestPnlEl = document.getElementById('best-day-pnl');
        const bestDateEl = document.getElementById('best-day-date');
        if (data.best_day && bestPnlEl) {
            const val = Number(data.best_day.pnl).toFixed(2);
            const sign = data.best_day.pnl >= 0 ? '+' : '';
            bestPnlEl.textContent = `${sign}₹${Math.abs(val).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        if (data.best_day && bestDateEl) {
            bestDateEl.textContent = data.best_day.date || '—';
        }

        const badPnlEl = document.getElementById('bad-day-pnl');
        const badDateEl = document.getElementById('bad-day-date');
        if (data.worst_day && badPnlEl) {
            const val = Number(data.worst_day.pnl).toFixed(2);
            const sign = data.worst_day.pnl >= 0 ? '+' : '';
            badPnlEl.textContent = `${sign}₹${Math.abs(val).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        if (data.worst_day && badDateEl) {
            badDateEl.textContent = data.worst_day.date || '—';
        }

        // 6. Last updated time
        lastUpdateTime = new Date();
        if (lastUpdatedEl) {
            lastUpdatedEl.textContent = `Last updated: ${lastUpdateTime.toLocaleTimeString('en-IN', {hour12: true})}`;
        }
    })
    .catch(err => {
        console.warn('Dashboard refresh failed:', err);
        if (heartbeatEl && !silent) heartbeatEl.textContent = 'Offline';
    })
    .finally(() => {
        isRefreshing = false;
    });
}

// Poll every 3 seconds – always running (no conditions)
setInterval(() => refreshDashboard(), 2000);

// Initial load + staggered quick fetches
window.addEventListener('load', () => {
    refreshDashboard(true);   // silent first fetch
    setTimeout(() => refreshDashboard(), 2000);
    setTimeout(() => refreshDashboard(), 1000);
});
</script>
{% endblock %}