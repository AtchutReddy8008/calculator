{% extends 'base.html' %}

{% block title %}Dashboard - Trade with Naman{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg: #0a0e17;
        --card-bg: rgba(20, 25, 35, 0.78);
        --card-border: rgba(88, 166, 255, 0.16);
        --glass-border: rgba(100, 180, 255, 0.20);
        --text: #e9effa;
        --text-muted: #a0a8b8;
        --primary: #60a5fa;
        --primary-dark: #3b82f6;
        --success: #34d399;
        --danger: #f87171;
        --warning: #fbbf24;
        --glow-success: 0 0 20px rgba(52, 211, 153, 0.55);
        --glow-danger: 0 0 18px rgba(248, 113, 113, 0.45);
        --glow-primary: 0 0 22px rgba(96, 165, 250, 0.55);
    }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* Background - elegant & subtle */
    .trading-bg {
        position: fixed;
        inset: 0;
        z-index: -2;
        pointer-events: none;
        background: radial-gradient(circle at 30% 70%, rgba(30, 58, 138, 0.14), transparent 65%);
    }

    .trading-bg::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(10, 14, 23, 0.94) 0%, rgba(10, 14, 23, 0.78) 100%);
        backdrop-filter: blur(3px);
    }

    /* Subtle animated flow lines */
    .market-flow {
        position: absolute;
        inset: 0;
        opacity: 0.3;
    }

    .flow-line {
        position: absolute;
        height: 1.2px;
        width: 180%;
        background: linear-gradient(90deg, transparent, var(--primary) 35%, transparent 65%);
        filter: blur(1.2px);
        opacity: 0.55;
        animation: flow 100s linear infinite;
    }

    .flow-line:nth-child(odd) {
        background: linear-gradient(90deg, transparent, var(--success) 35%, transparent 65%);
    }

    @keyframes flow {
        0% { transform: translateX(-45%); }
        100% { transform: translateX(45%); }
    }

    /* Cards & Glassmorphism */
    .card, .stat-card {
        background: var(--card-bg);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid var(--glass-border);
        border-radius: 18px;
        box-shadow: 0 12px 35px rgba(0,0,0,0.38);
        transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        overflow: hidden;
        position: relative;
    }

    .card:hover, .stat-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        border-color: rgba(96, 165, 250, 0.38);
    }

    .stat-card {
        padding: 2rem 1.6rem;
        text-align: center;
    }

    .stat-card .icon {
        font-size: 2.1rem;
        margin-bottom: 0.9rem;
        opacity: 0.9;
    }

    .stat-card .value {
        font-size: 2.6rem;
        font-weight: 800;
        letter-spacing: -1.2px;
        line-height: 1;
        margin-bottom: 0.5rem;
        transition: all 0.4s ease;
    }

    .stat-card .label {
        font-size: 0.95rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 500;
    }

    .status-running {
        color: var(--success);
        font-weight: 800;
        text-shadow: var(--glow-success);
    }

    .profit { color: var(--success) !important; text-shadow: var(--glow-success); }
    .loss   { color: var(--danger)   !important; text-shadow: var(--glow-danger); }

    /* Headings */
    h1, h5 {
        font-weight: 700;
        letter-spacing: -0.6px;
    }

    h1 {
        font-size: 2.6rem;
        background: linear-gradient(90deg, #e9effa, #60a5fa, #a5d6ff, #60a5fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: shine 6s linear infinite;
    }

    @keyframes shine {
        to { background-position: 200% center; }
    }

    /* Buttons */
    .btn-primary {
        background: var(--primary);
        border: none;
        font-weight: 600;
        border-radius: 12px;
        padding: 0.85rem 1.8rem;
        box-shadow: 0 6px 18px rgba(96,165,250,0.4);
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: #3b82f6;
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(59,130,246,0.55);
    }

    .btn-outline-primary {
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
    }

    /* ============================================== */
    /* FIXED & IMPROVED RECENT TRADES TABLE          */
    /* ============================================== */

    .table-responsive {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(96, 165, 250, 0.25);
    }

    .table {
        --bs-table-color: #ffffff !important;              /* All text in td is WHITE */
        --bs-table-bg: rgba(25, 35, 55, 0.82) !important;  /* Visible dark background per row */
        --bs-table-accent-bg: rgba(35, 48, 70, 0.90) !important; /* Zebra stripe - slightly darker */
        --bs-table-hover-bg: rgba(59, 130, 246, 0.30) !important; /* Strong blue hover */
        --bs-table-border-color: rgba(148, 163, 184, 0.50) !important;
        margin-bottom: 0;
    }

    .table thead th {
        background: rgba(10, 15, 30, 0.98) !important;
        color: #ffffff !important;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        border-bottom: 3px solid rgba(96, 165, 250, 0.6) !important;
        padding: 1.1rem 0.8rem;
    }

    .table tbody td {
        padding: 0.95rem 0.8rem;
        vertical-align: middle;
        border-top: 1px solid rgba(148, 163, 184, 0.30);
        color: #ffffff !important; /* Force white text in every cell */
    }

    .table tbody tr {
        transition: background 0.25s ease;
    }

    .table tbody tr:hover {
        background: rgba(59, 130, 246, 0.35) !important;
    }

    /* Profit/loss in P&L column - brighter & bolder */
    .table .profit {
        color: #4ade80 !important;
        font-weight: 800;
        text-shadow: 0 0 8px rgba(74, 222, 128, 0.6);
    }

    .table .loss {
        color: #fb7185 !important;
        font-weight: 800;
        text-shadow: 0 0 8px rgba(251, 113, 133, 0.6);
    }

    /* Status badges more visible & modern */
    .badge.bg-success {
        background-color: #10b981 !important;
        color: white !important;
        font-weight: 700;
        box-shadow: 0 2px 10px rgba(16, 185, 129, 0.5);
    }

    .badge.bg-danger {
        background-color: #ef4444 !important;
        color: white !important;
        font-weight: 700;
        box-shadow: 0 2px 10px rgba(239, 68, 68, 0.5);
    }

    .badge.bg-warning {
        background-color: #f59e0b !important;
        color: black !important;
        font-weight: 700;
    }

    .badge.bg-secondary {
        background-color: #64748b !important;
        color: white !important;
        font-weight: 700;
    }

    /* Animations */
    .fade-in-up {
        opacity: 0;
        transform: translateY(25px);
        animation: fadeUp 0.9s ease-out forwards;
    }

    @keyframes fadeUp {
        to { opacity: 1; transform: translateY(0); }
    }

    .stat-card:nth-child(1) { animation-delay: 0.15s; }
    .stat-card:nth-child(2) { animation-delay: 0.3s;  }
    .stat-card:nth-child(3) { animation-delay: 0.45s; }
    .stat-card:nth-child(4) { animation-delay: 0.6s;  }

    /* Mobile adjustments */
    @media (max-width: 767px) {
        h1 { font-size: 2.1rem; }
        .stat-card .value { font-size: 2.1rem; }
        .stat-card { padding: 1.6rem 1.3rem; }
        .stat-card .icon { font-size: 1.8rem; }
        .table thead th { font-size: 0.82rem; padding: 0.9rem 0.6rem; }
        .table tbody td { font-size: 0.9rem; padding: 0.75rem 0.6rem; }
    }

    /* Number change animation */
    .number-change {
        animation: pulse 1.2s ease-out;
    }

    @keyframes pulse {
        0%   { transform: scale(1.08); }
        50%  { transform: scale(0.95); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}

<!-- Background -->
<div class="trading-bg">
    <div class="market-flow">
        <div class="flow-line" style="top: 12%; animation-duration: 85s;"></div>
        <div class="flow-line" style="top: 32%; animation-duration: 100s;"></div>
        <div class="flow-line" style="top: 52%; animation-duration: 115s;"></div>
        <div class="flow-line" style="top: 72%; animation-duration: 95s;"></div>
    </div>
</div>

<main class="flex-grow-1">
    <div class="container-fluid py-4 dashboard-content">
        <div class="row mb-5">
            <div class="col-12">
                <h1 class="fade-in-up">
                    <i class="fas fa-tachometer-alt me-3"></i>
                    Trading Dashboard
                </h1>
            </div>
        </div>

        <!-- === Quick Stats - Most important cards === -->
        <div class="row g-4">
            <!-- Algo Status - most prominent -->
            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-power-off icon status-running"></i>
                    <div class="value status-running" id="bot-status-value">
                        {% if bot_status.is_running %}
                            Running
                        {% else %}
                            Stopped
                        {% endif %}
                    </div>
                    <div class="label">Algo Status</div>
                </div>
            </div>

            <!-- Today's P&L - second most important -->
            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-rupee-sign icon" style="color: var(--success);"></i>
                    <div class="value {% if daily_pnl.pnl >= 0 %}profit{% else %}loss{% endif %}" id="today-pnl">
                        ₹{{ daily_pnl.pnl|default:0|floatformat:2 }}
                    </div>
                    <div class="label">Today's P&L</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-calendar-week icon" style="color: var(--primary);"></i>
                    <div class="value {% if weekly_pnl >= 0 %}profit{% else %}loss{% endif %}" id="weekly-pnl">
                        ₹{{ weekly_pnl|floatformat:2 }}
                    </div>
                    <div class="label">Weekly P&L</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card fade-in-up">
                    <i class="fas fa-calendar-month icon" style="color: var(--primary);"></i>
                    <div class="value {% if monthly_pnl >= 0 %}profit{% else %}loss{% endif %}" id="monthly-pnl">
                        ₹{{ monthly_pnl|floatformat:2 }}
                    </div>
                    <div class="label">Monthly P&L</div>
                </div>
            </div>
        </div>

        <!-- Control & Summary -->
        <div class="row mt-5 g-4">
            <div class="col-lg-8">
                <div class="card fade-in-up">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Algo Control</h5>
                        <span class="badge {% if bot_status.is_running %}bg-success{% else %}bg-danger{% endif %} px-4 py-2 fs-6">
                            {{ bot_status.status|default:"live" }}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-4">
                                        <strong>Status:</strong> 
                                        <span id="bot-status-detail" class="{% if bot_status.is_running %}status-running{% else %}text-danger{% endif %} fw-bold ms-2">
                                            {% if bot_status.is_running %}RUNNING{% else %}STOPPED{% endif %}
                                        </span>
                                    </li>
                                    <li class="mb-4">
                                        <strong>Last Started:</strong> 
                                        <span class="ms-2">{{ bot_status.last_started|default:"Never"|date:"d M Y H:i" }}</span>
                                    </li>
                                    <li class="mb-4">
                                        <strong>Current P&L:</strong> 
                                        <span id="current-pnl" class="{% if bot_status.current_unrealized_pnl >= 0 %}profit{% else %}loss{% endif %} fw-bold ms-2">
                                            ₹{{ bot_status.current_unrealized_pnl|floatformat:2|default:"0.00" }}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid gap-3 mt-3 mt-md-0">
                                    <a href="{% url 'strategies_list' %}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-brain me-2"></i> Manage & Run Algo
                                    </a>
                                </div>
                            </div>
                        </div>

                        {% if bot_status.last_error %}
                            <div class="alert alert-danger mt-4 mb-0" role="alert">
                                <strong>Last Error:</strong>
                                <pre class="mb-0 mt-2 bg-transparent border-0 text-danger" style="font-size: 0.92rem; white-space: pre-wrap;">{{ bot_status.last_error }}</pre>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Performance Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-4">
                            <span>Win Rate</span>
                            <strong class="fs-5">{{ win_rate|default:"0" }}%</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Weekly Trades</span>
                            <strong class="fs-5">{{ weekly_trades|default:"0" }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Monthly Trades</span>
                            <strong class="fs-5">{{ monthly_trades|default:"0" }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Best Day</span>
                            <span class="profit fs-5">₹{{ performance.best_day.pnl|floatformat:2|default:"0.00" }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span>Worst Day</span>
                            <span class="loss fs-5">₹{{ performance.worst_day.pnl|floatformat:2|default:"0.00" }}</span>
                        </div>

                        <hr class="my-4">

                        <div class="text-center">
                            <a href="{% url 'pnl_calendar' %}" class="btn btn-outline-primary">
                                <i class="fas fa-calendar-alt me-2"></i> View Calendar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card fade-in-up">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i> Recent Trades</h5>
                        <a href="#" class="btn btn-sm btn-outline-primary">View All Trades</a>
                    </div>
                    <div class="card-body p-0">
                        {% if recent_trades %}
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Symbol</th>
                                            <th>Direction</th>
                                            <th>Qty</th>
                                            <th>Entry</th>
                                            <th>Exit</th>
                                            <th>P&L</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for trade in recent_trades %}
                                            <tr>
                                                <td>{{ trade.entry_time|date:"H:i:s" }}</td>
                                                <td class="fw-medium">{{ trade.symbol }}</td>
                                                <td>
                                                    {% if "BUY" in trade.metadata.action|upper %}
                                                        <span class="badge bg-success">BUY</span>
                                                    {% elif "SELL" in trade.metadata.action|upper %}
                                                        <span class="badge bg-danger">SELL</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ trade.metadata.action }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ trade.quantity }}</td>
                                                <td>₹{{ trade.entry_price|floatformat:2 }}</td>
                                                <td>
                                                    {% if trade.exit_price %}
                                                        ₹{{ trade.exit_price|floatformat:2 }}
                                                    {% else %}
                                                        —
                                                    {% endif %}
                                                </td>
                                                <td class="{% if trade.pnl >= 0 %}profit{% else %}loss{% endif %} fw-bold">
                                                    ₹{{ trade.pnl|floatformat:2 }}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if trade.status == 'EXECUTED' %}success{% elif trade.status == 'PENDING' %}warning{% else %}danger{% endif %}">
                                                        {{ trade.status }}
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                                <p>No recent trades executed yet.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Navigation -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card fade-in-up">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-compass me-2"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3 col-6">
                                <a href="{% url 'broker' %}" class="btn btn-outline-primary w-100 py-3">
                                    <i class="fas fa-plug me-2"></i> Broker Setup
                                </a>
                            </div>
                            <div class="col-md-3 col-6">
                                <a href="{% url 'pnl_calendar' %}" class="btn btn-outline-success w-100 py-3">
                                    <i class="fas fa-calendar-alt me-2"></i> P&L Calendar
                                </a>
                            </div>
                            <div class="col-md-3 col-6">
                                <a href="{% url 'strategies_list' %}" class="btn btn-outline-info w-100 py-3">
                                    <i class="fas fa-brain me-2"></i> Strategies
                                </a>
                            </div>
                            <div class="col-md-3 col-6">
                                <a href="/admin/" class="btn btn-outline-secondary w-100 py-3" target="_blank">
                                    <i class="fas fa-cog me-2"></i> Admin Panel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<script>
// Auto-refresh dashboard stats - improved version
function refreshDashboard() {
    const pnlElement = document.getElementById('current-pnl');
    const statusElement = document.getElementById('bot-status-value');
    const detailElement = document.getElementById('bot-status-detail');

    // Optional: show updating state
    if (pnlElement) pnlElement.style.opacity = '0.6';

    fetch('{% url "dashboard_stats" %}')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            // Current unrealized P&L
            if (pnlElement) {
                const val = data.current_unrealized_pnl.toFixed(2);
                const oldVal = pnlElement.textContent.replace('₹', '').trim();
                pnlElement.textContent = `₹${val}`;

                // Animate only on change
                if (oldVal !== val) {
                    pnlElement.classList.add('number-change');
                    setTimeout(() => pnlElement.classList.remove('number-change'), 1200);
                }

                // Color
                pnlElement.className = data.current_unrealized_pnl >= 0 
                    ? 'profit fw-bold ms-2 number-change' 
                    : 'loss fw-bold ms-2 number-change';
            }

            // Bot status
            if (statusElement) {
                statusElement.textContent = data.bot_running ? 'Running' : 'Stopped';
            }
            if (detailElement) {
                detailElement.innerHTML = data.bot_running 
                    ? '<span class="status-running">RUNNING</span>' 
                    : '<span class="text-danger">STOPPED</span>';
            }

            // Today/Weekly/Monthly P&L
            ['today-pnl', 'weekly-pnl', 'monthly-pnl'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const key = id.split('-')[0];
                    const value = data[`${key}_pnl`].toFixed(2);
                    const oldVal = el.textContent.replace('₹', '').trim();
                    el.textContent = `₹${value}`;

                    if (oldVal !== value) {
                        el.classList.add('number-change');
                        setTimeout(() => el.classList.remove('number-change'), 1200);
                    }

                    el.className = `value ${data[`${key}_pnl`] >= 0 ? 'profit' : 'loss'}`;
                }
            });

            // Restore opacity
            if (pnlElement) pnlElement.style.opacity = '1';
        })
        .catch(error => {
            console.error('Dashboard update failed:', error);
            // Optional: show warning once
            if (!document.getElementById('refresh-warning')) {
                const warning = document.createElement('div');
                warning.id = 'refresh-warning';
                warning.className = 'alert alert-warning mt-3 small';
                warning.textContent = 'Live updates temporarily unavailable. Please refresh page.';
                document.querySelector('.dashboard-content').prepend(warning);
            }
        });
}

// Run immediately + every 8 seconds (good balance between fresh & not spamming server)
setInterval(refreshDashboard, 8000);
refreshDashboard();
</script>
{% endblock %}